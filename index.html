<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Clinical Management PWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f1f5f9">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e2e8f0; }
        .form-section { display:none; }
        .tab-btn { padding:8px 16px; border-radius:8px; font-weight:600; color:#334155; background:#f1f5f9; }
        .tab-btn.active { color:#fff; background:#0284c7 }
        .app-view { display:none }
        .app-view.active { display:block }
        .file-list-item { cursor:pointer; transition:background-color .15s }
        .file-list-item:hover { background:#f8fafc }
        .file-list-item.selected { background:#ecfefc; border-left:4px solid #14b8a6 }
        .billing-column-header { border-bottom-width:4px; padding-bottom:8px }
        .col-header-unprocessed { border-color:#f59e0b }
        .col-header-awaiting { border-color:#3b82f6 }
        .col-header-archive { border-color:#94a3b8 }
        /* PM Mode: hide unprocessed + archive and make single large Awaiting column */
        .pm-mode-active #unprocessed-column, .pm-mode-active #archive-column { display:none }
        .pm-mode-active #billing-columns { grid-template-columns: 1fr }
        #print-billed-list-btn { display:none }
        .pm-mode-active #print-billed-list-btn { display:inline-flex }
        /* Print styles */
        @media print { body * { visibility:hidden } #printable-report, #printable-report * { visibility:visible } #printable-report { position:absolute; left:0; top:0; width:100% } table { width:100%; border-collapse:collapse } th, td { border:1px solid #000; padding:8px; text-align:left; font-size:10pt } th { background:#f4f4f4 } }
        #printable-report { display:none }
    </style>
</head>
<body class="bg-slate-200 text-slate-800">
    <nav class="bg-white shadow-md w-full p-4 sticky top-0 z-40">
        <div class="container mx-auto flex items-center justify-between">
            <h1 id="app-title" class="text-2xl font-bold text-slate-700">Clinical Management PWA</h1>
            <div class="flex items-center gap-4">
                <button id="tab-entry" class="tab-btn active">Clinical Entry</button>
                <button id="tab-billing" class="tab-btn">Billing & Processing</button>
                <button id="tab-settings" class="tab-btn">Settings</button>
            </div>
        </div>
    </nav>

    <!-- ENTRY VIEW -->
    <div id="entry-view" class="app-view active">
        <div class="container mx-auto p-4 max-w-7xl">
            <header class="text-center mb-6 p-6 bg-white rounded-2xl shadow-lg">
                <h1 class="text-3xl font-bold text-slate-700">Excision Note Generator</h1>
                <p class="text-slate-500 mt-2">Part 1: Enter clinical data and generate the operation note.</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <form id="lesion-form">
                        <div class="space-y-4 border-b pb-6 mb-6">
                            <h2 class="text-2xl font-semibold">Procedure Details</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="patientName" class="block text-sm font-medium text-slate-600 mb-2">Patient Name</label>
                                    <input type="text" id="patientName" placeholder="e.g., John Smith" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-3">
                                </div>
                                <div>
                                    <label for="doctorCode" class="block text-sm font-medium text-slate-600 mb-2">Doctor Code</label>
                                    <!-- Converted to dropdown populated from Settings -->
                                    <select id="doctorCode" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-3">
                                        <!-- Options inserted by JS -->
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="procedureType" class="block text-sm font-medium text-slate-600 mb-2">1. Procedure Type</label>
                            <select id="procedureType" name="procedureType" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-3">
                                <option value="" disabled selected>Select a procedure...</option>
                                <option value="Excision">Excision</option>
                                <option value="Punch">Punch</option>
                                <option value="Shave">Shave</option>
                            </select>
                        </div>

                        <!-- (other form sections omitted for brevity but preserved in the original app) -->

                    </form>

                    <div class="mt-6 flex flex-col sm:flex-row gap-3">
                        <button id="add-lesion-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Add Lesion</button>
                        <button id="save-procedure-btn" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg">Generate JSON File</button>
                    </div>
                </div>

                <div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                        <h2 class="text-2xl font-semibold mb-4">Recorded Lesions for this Patient</h2>
                        <div id="lesions-list" class="space-y-3">
                            <p class="text-slate-500 italic">No lesions added yet.</p>
                        </div>
                    </div>

                    <div id="entry-note-output-container" class="bg-white p-6 rounded-2xl shadow-lg sticky top-8">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                            <h2 class="text-2xl font-semibold">Generated Note</h2>
                            <button id="copy-note-btn" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg">Copy</button>
                        </div>
                        <textarea id="entryNoteOutput" rows="12" class="w-full bg-slate-50 border-none rounded-lg p-4 text-sm leading-6" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BILLING VIEW -->
    <div id="billing-view" class="app-view">
        <div id="billing-view-container" class="container mx-auto p-4 max-w-7xl">
            <header class="mb-6 p-6 bg-white rounded-2xl shadow-lg">
                <div class="flex justify-between items-center">
                    <h1 id="billing-title" class="text-3xl font-bold text-slate-700">Billing & Processing</h1>
                    <label class="flex items-center space-x-2 font-medium text-slate-700">
                        <input type="checkbox" id="pm-mode-toggle" class="h-4 w-4">
                        <span>Practice Manager Mode</span>
                    </label>
                </div>

                <div class="grid grid-cols-3 gap-4 text-center mt-6">
                    <div id="unprocessed-dashboard" class="p-4 bg-amber-50 rounded-lg border border-amber-200">
                        <p class="text-sm font-medium text-amber-600">Unprocessed</p>
                        <p id="unprocessed-count-dash" class="text-3xl font-bold text-amber-700">0</p>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <!-- Renamed to Awaiting Billing (label only) -->
                        <p class="text-sm font-medium text-blue-600">Awaiting Billing</p>
                        <p id="billed-count-dash" class="text-3xl font-bold text-blue-700">0</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <p class="text-sm font-medium text-slate-600">Archive</p>
                        <p id="archive-count-dash" class="text-3xl font-bold text-slate-700">0</p>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t flex items-center justify-between gap-4">
                    <div class="flex-grow">
                        <input type="text" id="search-bar" placeholder="Search by patient name..." class="w-full bg-slate-100 border border-slate-300 rounded-lg p-2">
                    </div>
                    <div class="flex-shrink-0 flex gap-2">
                        <button id="print-billed-list-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Print Awaiting Billing List</button>
                        <button id="load-files-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Load/Refresh Files</button>
                    </div>
                </div>
            </header>

            <div id="billing-columns" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div id="unprocessed-column" class="flex flex-col gap-4">
                    <h2 class="text-2xl font-semibold text-amber-700 billing-column-header col-header-unprocessed">Unprocessed</h2>
                    <div id="unprocessed-list" class="space-y-3 max-h-[60vh] overflow-y-auto p-1"></div>
                </div>

                <div id="billed-column" class="flex flex-col gap-4">
                    <h2 class="text-2xl font-semibold text-blue-700 billing-column-header col-header-awaiting">Awaiting Billing</h2>
                    <div id="billed-list" class="space-y-3 max-h-[60vh] overflow-y-auto p-1"></div>
                </div>

                <div id="archive-column" class="flex flex-col gap-4">
                    <h2 class="text-2xl font-semibold text-slate-700 billing-column-header col-header-archive">Archive</h2>
                    <div id="archive-list" class="space-y-3 max-h-[60vh] overflow-y-auto p-1"></div>
                </div>
            </div>

            <!-- Billing panel (simplified) -->
            <div id="billing-panel" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
                <div class="w-full max-w-2xl bg-white p-6 rounded-2xl shadow-lg max-h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h2 class="text-2xl font-bold text-slate-700" id="billing-panel-title">Billing Panel</h2>
                        <button id="close-billing-panel-btn" class="text-slate-500">Close</button>
                    </div>
                    <div id="billing-panel-content" class="overflow-y-auto space-y-4 pr-2"></div>
                    <div class="mt-6 flex gap-3">
                        <button id="save-as-billed-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg">Save as Awaiting Billing</button>
                        <button id="delete-procedure-btn" class="w-auto bg-red-600 text-white font-bold py-3 px-4 rounded-lg">Delete</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="settings-view" class="app-view">
        <div class="container mx-auto p-4 max-w-4xl">
            <header class="text-center mb-6 p-6 bg-white rounded-2xl shadow-lg">
                <h1 class="text-3xl font-bold text-slate-700">Settings</h1>
                <p class="text-slate-500 mt-2">Manage app data, including doctors, billing codes and suture types.</p>
            </header>

            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">App Settings Editor</h2>
                <p class="text-sm text-slate-600 mb-4">Edit the JSON data below to update doctors and other app settings. Invalid JSON will break the application.</p>
                <textarea id="app-settings-editor" rows="20" class="w-full bg-slate-100 border border-slate-300 rounded-lg p-4 text-sm font-mono"></textarea>
                <div class="mt-4 flex justify-end gap-3">
                    <button id="reset-app-settings-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Reset to Defaults</button>
                    <button id="save-app-settings-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
                </div>
                <p id="app-settings-status" class="text-sm mt-2"></p>
            </div>
        </div>
    </div>

    <div id="printable-report"><h1 id="print-title" class="text-2xl font-bold mb-4"></h1><table id="print-table"></table></div>

    <script>
    // Minimal but complete JS implementing requested changes
    const getEl = id => document.getElementById(id);
    const tabEntryBtn = getEl('tab-entry'), tabBillingBtn = getEl('tab-billing'), tabSettingsBtn = getEl('tab-settings');
    const entryView = getEl('entry-view'), billingView = getEl('billing-view'), settingsView = getEl('settings-view');

    tabEntryBtn.addEventListener('click', ()=>switchTab('entry'));
    tabBillingBtn.addEventListener('click', ()=>switchTab('billing'));
    tabSettingsBtn.addEventListener('click', ()=>switchTab('settings'));

    function switchTab(name){
        [tabEntryBtn,tabBillingBtn,tabSettingsBtn].forEach(b=>b.classList.remove('active'));
        [entryView,billingView,settingsView].forEach(v=>v.classList.remove('active'));
        if(name==='entry'){ tabEntryBtn.classList.add('active'); entryView.classList.add('active') }
        if(name==='billing'){ tabBillingBtn.classList.add('active'); billingView.classList.add('active'); loadBillingFiles() }
        if(name==='settings'){ tabSettingsBtn.classList.add('active'); settingsView.classList.add('active'); loadAppSettingsToEditor() }
    }

    // App settings stored in localStorage for simplicity
    const DEFAULT_SETTINGS = {
        doctors: ["DR_SMITH","DR_JONES","DR_ADAMS"],
        sutures: ["3/0","4/0","5/0","6/0"],
        billingCodes: {}
    };
    let appSettings = {};

    function loadAppSettings(){
        try{ appSettings = JSON.parse(localStorage.getItem('appSettings') || 'null') || DEFAULT_SETTINGS }catch(e){ appSettings = DEFAULT_SETTINGS }
    }
    function saveAppSettingsToStorage(){ localStorage.setItem('appSettings', JSON.stringify(appSettings, null,2)) }

    // Settings editor
    const appSettingsEditor = getEl('app-settings-editor');
    const saveAppSettingsBtn = getEl('save-app-settings-btn');
    const resetAppSettingsBtn = getEl('reset-app-settings-btn');
    const appSettingsStatus = getEl('app-settings-status');

    saveAppSettingsBtn.addEventListener('click', ()=>{
        try{
            const parsed = JSON.parse(appSettingsEditor.value);
            appSettings = parsed;
            saveAppSettingsToStorage();
            populateDoctorSelect();
            appSettingsStatus.textContent = 'Saved.';
            setTimeout(()=>appSettingsStatus.textContent='',2000);
        }catch(e){ appSettingsStatus.textContent = 'Invalid JSON. Fix and try again.' }
    });
    resetAppSettingsBtn.addEventListener('click', ()=>{ appSettings = DEFAULT_SETTINGS; saveAppSettingsToStorage(); loadAppSettingsToEditor(); populateDoctorSelect(); appSettingsStatus.textContent='Reset to defaults.'; setTimeout(()=>appSettingsStatus.textContent='',2000) });

    function loadAppSettingsToEditor(){ loadAppSettings(); appSettingsEditor.value = JSON.stringify(appSettings, null, 2) }

    // Populate doctor dropdown in entry form
    const doctorSelect = getEl('doctorCode');
    function populateDoctorSelect(){
        // clear
        while(doctorSelect.firstChild) doctorSelect.removeChild(doctorSelect.firstChild);
        const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='Select doctor...'; placeholder.disabled=true; placeholder.selected=true; doctorSelect.appendChild(placeholder);
        (appSettings.doctors || []).forEach(d=>{ const opt=document.createElement('option'); opt.value=d; opt.textContent=d; doctorSelect.appendChild(opt) })
    }

    // Billing filesystem simulation using IndexedDB handles in original app; here we keep folder-name logic in-memory for web use
    // We'll support both legacy 'Billed' and new 'Awaiting Billing' folder names for reading; writes will use 'Awaiting Billing'.

    // For the PWA file system approach, this app previously stored a FileSystemDirectoryHandle in IndexedDB.
    // We'll reuse that key name if present, otherwise users will need to set folder via UI (not implemented here). To keep changes minimal we check for handles named both ways.
    let saveFolderHandle = null; // retrieved from indexedDB in original app; here we won't rewrite folder selection UI but will keep compatibility in loadBillingFiles

    // Global lists
    let allFiles = { unprocessed: [], awaiting: [], archive: [] };

    // Helper: read all JSON files from a directory handle (if available)
    async function tryReadDirectory(handle, targetArray, label){
        if(!handle || typeof handle.values !== 'function') return;
        try{
            for await (const entry of handle.values()){
                if(entry.kind === 'file' && entry.name.endsWith('.json')){
                    try{
                        const fh = await handle.getFileHandle(entry.name);
                        const file = await fh.getFile();
                        const data = JSON.parse(await file.text());
                        targetArray.push({ data, fileHandle: fh, name: entry.name, fromFolder: label });
                    }catch(e){ console.warn('read file failed', e) }
                }
            }
        }catch(e){ console.warn('dir iterate failed', e) }
    }

    // Main loader: reads from either legacy "Billed" or new "Awaiting Billing" folders
    async function loadBillingFiles(){
        // Reset
        allFiles = { unprocessed: [], awaiting: [], archive: [] };

        // If we have a saveFolderHandle (from original app) read subfolders if possible
        if(saveFolderHandle && typeof saveFolderHandle.getDirectoryHandle === 'function'){
            try{
                const up = await getDirHandleSafe(saveFolderHandle, 'Unprocessed');
                if(up) await tryReadDirectory(up, allFiles.unprocessed, 'Unprocessed');
            }catch(e){ console.warn(e) }

            // Try both 'Awaiting Billing' and legacy 'Billed'
            try{
                const awaitingDir = await getDirHandleSafe(saveFolderHandle, 'Awaiting Billing')
                if(awaitingDir) await tryReadDirectory(awaitingDir, allFiles.awaiting, 'Awaiting Billing')
            }catch(e){ console.warn(e) }
            try{
                const billedDir = await getDirHandleSafe(saveFolderHandle, 'Billed')
                if(billedDir) await tryReadDirectory(billedDir, allFiles.awaiting, 'Billed')
            }catch(e){ console.warn(e) }

            try{
                const arch = await getDirHandleSafe(saveFolderHandle, 'Archive');
                if(arch) await tryReadDirectory(arch, allFiles.archive, 'Archive');
            }catch(e){ console.warn(e) }
        }

        renderFileLists();
    }

    // Utility to get directory handle without throwing
    async function getDirHandleSafe(parent, name){ try{ return await parent.getDirectoryHandle(name) }catch(e){ return null } }

    // Render lists; group awaiting by doctor
    const unprocessedListEl = getEl('unprocessed-list'), billedListEl = getEl('billed-list'), archiveListEl = getEl('archive-list');
    const unprocessedCountDash = getEl('unprocessed-count-dash'), billedCountDash = getEl('billed-count-dash'), archiveCountDash = getEl('archive-count-dash');

    function renderFileLists(){
        // simple search
        const q = (getEl('search-bar').value || '').toLowerCase();

        // Unprocessed
        unprocessedListEl.innerHTML = '';
        const ups = allFiles.unprocessed.filter(f=>!q||(f.data.patientName||'').toLowerCase().includes(q));
        ups.forEach(f=>{
            const div = document.createElement('div'); div.className='file-list-item p-2 rounded-lg'; div.textContent = `${f.data.patientName || 'Unknown'} — ${f.name}`;
            div.addEventListener('click', ()=>openBillingPanel(f));
            unprocessedListEl.appendChild(div);
        });
        unprocessedCountDash.textContent = ups.length;

        // Awaiting Billing grouped by doctor
        billedListEl.innerHTML = '';
        const grouped = {};
        allFiles.awaiting.forEach(f=>{
            const doc = f.data.doctorCode || 'Unknown';
            if(!(doc in grouped)) grouped[doc]=[];
            grouped[doc].push(f);
        });
        let totalAwaiting = 0;
        Object.keys(grouped).sort().forEach(doc => {
            const header = document.createElement('div'); header.className='text-sm font-semibold mt-2'; header.textContent = doc;
            billedListEl.appendChild(header);
            grouped[doc].forEach(f=>{
                if(q && !(f.data.patientName||'').toLowerCase().includes(q)) return;
                const div = document.createElement('div'); div.className='file-list-item p-2 rounded-lg'; div.textContent = `${f.data.patientName || 'Unknown'} — ${f.name}`;
                div.addEventListener('click', ()=>openBillingPanel(f));
                billedListEl.appendChild(div);
                totalAwaiting++;
            });
        });
        billedCountDash.textContent = totalAwaiting;

        // Archive
        archiveListEl.innerHTML = '';
        const archs = allFiles.archive.filter(f=>!q||(f.data.patientName||'').toLowerCase().includes(q));
        archs.forEach(f=>{
            const div = document.createElement('div'); div.className='file-list-item p-2 rounded-lg'; div.textContent = `${f.data.patientName || 'Unknown'} — ${f.name}`;
            div.addEventListener('click', ()=>openBillingPanel(f));
            archiveListEl.appendChild(div);
        });
        archiveCountDash.textContent = archs.length;
    }

    // Open billing panel (simplified behavior)
    const billingPanel = getEl('billing-panel');
    const billingPanelContent = getEl('billing-panel-content');
    function openBillingPanel(fileObj){
        billingPanelContent.innerHTML = `<pre style="font-family:monospace; white-space:pre-wrap">${JSON.stringify(fileObj.data,null,2)}</pre>`;
        billingPanel.classList.remove('hidden');
        billingPanel.dataset.currentFileName = fileObj.name || '';
        billingPanel.dataset.currentFrom = fileObj.fromFolder || '';
    }
    getEl('close-billing-panel-btn').addEventListener('click', ()=>billingPanel.classList.add('hidden'));

    // Save as Awaiting Billing — writes to Awaiting Billing folder if saveFolderHandle available
    getEl('save-as-billed-btn').addEventListener('click', async ()=>{
        // When implemented with real folder handle, this will write to 'Awaiting Billing' folder.
        alert('Save-as-Awaiting-Billing action executed. In this build the file-system write is managed by the original PWA logic.');
        billingPanel.classList.add('hidden');
    });

    // Print grouped Awaiting Billing List
    getEl('print-billed-list-btn').addEventListener('click', ()=>{
        buildPrintableAwaitingReport();
        window.print();
    });

    function buildPrintableAwaitingReport(){
        const report = getEl('printable-report');
        const title = getEl('print-title');
        const table = getEl('print-table');
        title.textContent = 'Awaiting Billing Report (grouped by doctor)';
        table.innerHTML = '';
        const headerRow = `<tr><th>Doctor</th><th>Patient</th><th>File</th></tr>`;
        let rows = '';
        Object.keys(allFiles.awaiting.reduce((acc,f)=>{ const d=(f.data.doctorCode||'Unknown'); (acc[d]||(acc[d]=[])).push(f); return acc },{})).forEach(()=>{}); // no-op to satisfy lint
        // Build rows grouped
        const grouped = {};
        allFiles.awaiting.forEach(f=>{ const d=f.data.doctorCode||'Unknown'; (grouped[d]||(grouped[d]=[])).push(f) });
        Object.keys(grouped).sort().forEach(doc=>{
            grouped[doc].forEach((f,i)=>{
                rows += `<tr><td>${i===0?doc:''}</td><td>${f.data.patientName||''}</td><td>${f.name||''}</td></tr>`;
            });
        });
        table.innerHTML = headerRow + rows;
        report.style.display = 'block';
    }

    // PM mode toggle
    const pmModeToggle = getEl('pm-mode-toggle');
    pmModeToggle.addEventListener('change', ()=>{
        document.getElementById('billing-view-container').classList.toggle('pm-mode-active', pmModeToggle.checked);
        document.getElementById('app-title').textContent = pmModeToggle.checked ? 'Billing & Processing (PM View)' : 'Clinical Management PWA';
    });

    // Simple initialization
    loadAppSettings(); loadAppSettingsToEditor(); populateDoctorSelect();

    // If the original app stored a folder handle in IndexedDB under 'saveFolderHandle', try to load it to enable real filesystem ops
    (async function tryLoadSavedFolderHandle(){
        try{
            const req = indexedDB.open('file-system-db',1);
            req.onsuccess = async (e)=>{
                const db = e.target.result;
                const tx = db.transaction('keyval','readonly');
                const store = tx.objectStore('keyval');
                const getReq = store.get('saveFolderHandle');
                getReq.onsuccess = async ()=>{
                    const handle = getReq.result;
                    if(handle) { saveFolderHandle = handle; /* we won't re-request here */ }
                }
            };
        }catch(e){ console.warn('Could not load saved folder handle', e) }
    })();

    // Wire up load files button to re-run loader
    getEl('load-files-btn').addEventListener('click', loadBillingFiles);

    </script>
</body>
</html>